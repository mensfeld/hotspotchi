<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotSpotchi Dashboard</title>
    <link href="/static/css/daisyui.min.css" rel="stylesheet">
    <script src="/static/js/tailwind.js"></script>
    <style>
        .character-btn {
            transition: all 0.2s ease;
        }
        .character-btn:hover {
            transform: scale(1.05);
        }
        .character-btn.selected {
            ring: 2px;
            ring-primary;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="min-h-screen bg-base-200">
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Navbar -->
    <div class="navbar bg-primary text-primary-content shadow-lg">
        <div class="flex-1">
            <span class="text-xl font-bold px-4">HotSpotchi</span>
            <span class="badge badge-ghost">v{{ version }}</span>
        </div>
        <div class="flex-none gap-2">
            <!-- Hotspot Status -->
            <div class="badge" id="hotspot-badge">Offline</div>
            <div class="badge badge-secondary" id="status-badge">Loading...</div>

            <!-- Mode Selector -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 text-base-content">
                    <li class="menu-title">MAC Mode</li>
                    <li><a onclick="setMacMode('daily_random')" id="mode-daily_random">Daily Random</a></li>
                    <li><a onclick="setMacMode('random')" id="mode-random">Random</a></li>
                    <li><a onclick="setMacMode('cycle')" id="mode-cycle">Cycle</a></li>
                    <li><a onclick="setMacMode('fixed')" id="mode-fixed">Fixed</a></li>
                    <li><a onclick="setMacMode('disabled')" id="mode-disabled">Disabled</a></li>
                </ul>
            </div>

            <!-- Hotspot Controls -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M13 12a1 1 0 11-2 0 1 1 0 012 0z" />
                    </svg>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 text-base-content">
                    <li class="menu-title">Hotspot Control</li>
                    <li><a onclick="controlHotspot('start')">Start Hotspot</a></li>
                    <li><a onclick="controlHotspot('stop')">Stop Hotspot</a></li>
                    <li><a onclick="controlHotspot('restart')">Restart Hotspot</a></li>
                </ul>
            </div>
        </div>
    </div>

    <main class="container mx-auto p-4 max-w-5xl">
        <!-- Root Warning -->
        <div class="alert alert-warning mb-6" id="root-warning" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span>Not running as root. Hotspot controls are disabled. Run with: <code>sudo hotspotchi-web</code></span>
        </div>

        <!-- Current Status Card -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                    </svg>
                    Current Broadcast
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">SSID</div>
                        <div class="stat-value text-lg truncate" id="current-ssid">-</div>
                        <div class="stat-desc" id="ssid-mode-label">Normal mode</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">MAC Address</div>
                        <div class="stat-value text-sm font-mono" id="current-mac">-</div>
                        <div class="stat-desc" id="mac-mode-label">Daily random</div>
                    </div>
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">Character</div>
                        <div class="stat-value text-lg" id="current-character">-</div>
                        <div class="stat-desc">Meeting this Tama!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Countdown Timer (for daily mode) -->
        <div class="card bg-base-100 shadow-xl mb-6" id="countdown-card" style="display: none;">
            <div class="card-body items-center text-center">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Next Character In
                </h2>
                <div class="grid grid-flow-col gap-5 text-center auto-cols-max mt-4">
                    <div class="flex flex-col p-2 bg-neutral rounded-box text-neutral-content">
                        <span class="countdown font-mono text-5xl" id="hours">
                            <span style="--value:0;"></span>
                        </span>
                        hours
                    </div>
                    <div class="flex flex-col p-2 bg-neutral rounded-box text-neutral-content">
                        <span class="countdown font-mono text-5xl" id="minutes">
                            <span style="--value:0;"></span>
                        </span>
                        min
                    </div>
                    <div class="flex flex-col p-2 bg-neutral rounded-box text-neutral-content">
                        <span class="countdown font-mono text-5xl" id="seconds">
                            <span style="--value:0;"></span>
                        </span>
                        sec
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Characters (for cycle mode) -->
        <div class="card bg-base-100 shadow-xl mb-6" id="upcoming-card" style="display: none;">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    Upcoming Characters
                </h2>
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Character</th>
                                <th>MAC Address</th>
                            </tr>
                        </thead>
                        <tbody id="upcoming-list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tabs for Characters/SSIDs -->
        <div class="tabs tabs-boxed mb-4 justify-center">
            <a class="tab tab-active" id="tab-characters" onclick="showTab('characters')">MAC Characters</a>
            <a class="tab" id="tab-ssids" onclick="showTab('ssids')">Special SSIDs</a>
        </div>

        <!-- Character Selector -->
        <div class="card bg-base-100 shadow-xl" id="characters-panel">
            <div class="card-body">
                <div class="flex flex-wrap gap-2 mb-4">
                    <input type="text" placeholder="Search characters..."
                           class="input input-bordered flex-grow"
                           id="character-search"
                           oninput="filterCharacters()">
                    <select class="select select-bordered" id="season-filter" onchange="filterCharacters()">
                        <option value="">All Seasons</option>
                        <option value="spring">Spring</option>
                        <option value="summer">Summer</option>
                        <option value="fall">Fall</option>
                        <option value="winter">Winter</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"
                     id="character-grid">
                    <!-- Characters populated by JavaScript -->
                </div>
                <div class="text-center text-sm text-base-content/60 mt-4">
                    <span id="character-count">0</span> characters
                </div>
            </div>
        </div>

        <!-- Special SSIDs Panel -->
        <div class="card bg-base-100 shadow-xl" id="ssids-panel" style="display: none;">
            <div class="card-body">
                <div class="form-control mb-4">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" class="checkbox checkbox-primary" id="active-only" onchange="loadSSIDs()">
                        <span class="label-text">Show active only</span>
                    </label>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="ssid-grid">
                    <!-- SSIDs populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-300 text-base-content mt-8">
        <div>
            <p>HotSpotchi - Meet Tamagotchi characters via WiFi!</p>
        </div>
    </footer>

    <script>
        let countdownInterval;
        let secondsRemaining = 0;
        let allCharacters = [];
        let currentMacMode = 'daily_random';
        let isRoot = false;
        let hotspotRunning = false;

        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                document.getElementById('current-ssid').textContent = data.ssid;
                document.getElementById('current-mac').textContent = data.mac_address || 'Default';
                document.getElementById('current-character').textContent = data.character_name || 'None';
                document.getElementById('status-badge').textContent = data.mac_mode.replace('_', ' ');
                document.getElementById('mac-mode-label').textContent = data.mac_mode.replace('_', ' ') + ' mode';
                document.getElementById('ssid-mode-label').textContent = data.ssid_mode + ' mode';

                currentMacMode = data.mac_mode;
                isRoot = data.is_root;
                hotspotRunning = data.hotspot_running;

                // Update hotspot badge
                const hotspotBadge = document.getElementById('hotspot-badge');
                if (hotspotRunning) {
                    hotspotBadge.textContent = 'Running';
                    hotspotBadge.className = 'badge badge-success';
                } else {
                    hotspotBadge.textContent = 'Offline';
                    hotspotBadge.className = 'badge badge-ghost';
                }

                // Show root warning if not root
                document.getElementById('root-warning').style.display = isRoot ? 'none' : 'flex';

                // Update mode selector highlighting
                document.querySelectorAll('[id^="mode-"]').forEach(el => {
                    el.classList.remove('active');
                });
                const activeMode = document.getElementById(`mode-${data.mac_mode}`);
                if (activeMode) activeMode.classList.add('active');

                // Show countdown for daily mode
                if (data.mac_mode === 'daily_random' && data.seconds_until_change) {
                    document.getElementById('countdown-card').style.display = 'block';
                    document.getElementById('upcoming-card').style.display = 'none';
                    secondsRemaining = data.seconds_until_change;
                    startCountdown();
                } else {
                    document.getElementById('countdown-card').style.display = 'none';
                }

                // Show upcoming for cycle mode
                if (data.mac_mode === 'cycle') {
                    document.getElementById('upcoming-card').style.display = 'block';
                    document.getElementById('countdown-card').style.display = 'none';
                    loadUpcoming();
                } else if (data.mac_mode !== 'daily_random') {
                    document.getElementById('upcoming-card').style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load status:', error);
                document.getElementById('status-badge').textContent = 'Error';
            }
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);

            updateCountdownDisplay();
            countdownInterval = setInterval(() => {
                if (secondsRemaining <= 0) {
                    loadStatus();
                    return;
                }
                secondsRemaining--;
                updateCountdownDisplay();
            }, 1000);
        }

        function updateCountdownDisplay() {
            const hours = Math.floor(secondsRemaining / 3600);
            const minutes = Math.floor((secondsRemaining % 3600) / 60);
            const secs = secondsRemaining % 60;

            document.querySelector('#hours span').style.setProperty('--value', hours);
            document.querySelector('#minutes span').style.setProperty('--value', minutes);
            document.querySelector('#seconds span').style.setProperty('--value', secs);
        }

        async function loadCharacters() {
            try {
                const response = await fetch('/api/characters');
                allCharacters = await response.json();
                renderCharacters(allCharacters);
            } catch (error) {
                console.error('Failed to load characters:', error);
            }
        }

        function renderCharacters(characters) {
            const grid = document.getElementById('character-grid');
            grid.innerHTML = characters.map(char => `
                <button class="btn btn-outline btn-sm character-btn flex items-center justify-between gap-1 overflow-hidden"
                        onclick="selectCharacter(${char.index})"
                        data-name="${char.name.toLowerCase()}"
                        data-season="${char.season || ''}"
                        title="${char.name} - ${char.mac_address}">
                    <span class="truncate">${char.name}</span>
                    ${char.season ? '<span class="badge badge-xs badge-accent shrink-0">' + char.season.charAt(0).toUpperCase() + '</span>' : ''}
                </button>
            `).join('');
            document.getElementById('character-count').textContent = characters.length;
        }

        function filterCharacters() {
            const search = document.getElementById('character-search').value.toLowerCase();
            const season = document.getElementById('season-filter').value;

            let filtered = allCharacters;

            if (search) {
                filtered = filtered.filter(c => c.name.toLowerCase().includes(search));
            }

            if (season) {
                filtered = filtered.filter(c => c.season === season);
            }

            renderCharacters(filtered);
        }

        async function loadSSIDs() {
            try {
                const activeOnly = document.getElementById('active-only').checked;
                const response = await fetch(`/api/ssids?active_only=${activeOnly}`);
                const ssids = await response.json();

                const grid = document.getElementById('ssid-grid');
                grid.innerHTML = ssids.map(ssid => `
                    <div class="card bg-base-200 ${!ssid.active ? 'opacity-60' : ''}">
                        <div class="card-body p-4">
                            <h3 class="card-title text-sm">
                                ${ssid.character_name}
                                ${!ssid.active ? '<span class="badge badge-warning badge-sm">Inactive</span>' : ''}
                            </h3>
                            <p class="text-xs font-mono break-all">${ssid.ssid}</p>
                            <p class="text-xs text-base-content/60">${ssid.notes}</p>
                            <div class="card-actions justify-end mt-2">
                                <button class="btn btn-primary btn-xs" onclick="selectSSID(${ssid.index})" ${!ssid.active ? 'disabled' : ''}>
                                    Use This
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load SSIDs:', error);
            }
        }

        async function loadUpcoming() {
            try {
                const response = await fetch('/api/upcoming?count=7');
                const upcoming = await response.json();

                const list = document.getElementById('upcoming-list');
                list.innerHTML = upcoming.map(char => `
                    <tr>
                        <td>${char.position}</td>
                        <td>${char.name}</td>
                        <td class="font-mono text-sm">${char.mac_address}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load upcoming:', error);
            }
        }

        async function selectCharacter(index) {
            try {
                const apply = hotspotRunning && isRoot;
                const response = await fetch(`/api/character/${index}?apply=${apply}`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.applied) {
                        showToast(`Applied: ${result.character}`, 'success');
                    } else {
                        showToast(`Selected: ${result.character}`, 'info');
                    }
                    loadStatus();
                }
            } catch (error) {
                console.error('Failed to select character:', error);
                showToast('Error selecting character', 'error');
            }
        }

        async function selectSSID(index) {
            try {
                const apply = hotspotRunning && isRoot;
                const response = await fetch(`/api/ssid/${index}?apply=${apply}`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.applied) {
                        showToast(`Applied: ${result.character}`, 'success');
                    } else {
                        showToast(`Selected: ${result.character}`, 'info');
                    }
                    loadStatus();
                }
            } catch (error) {
                console.error('Failed to select SSID:', error);
                showToast('Error selecting SSID', 'error');
            }
        }

        async function setMacMode(mode) {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac_mode: mode })
                });
                if (response.ok) {
                    showToast(`Mode: ${mode.replace('_', ' ')}`, 'success');
                    // If hotspot is running and we're root, restart to apply
                    if (hotspotRunning && isRoot) {
                        await controlHotspot('restart');
                    }
                    loadStatus();
                }
            } catch (error) {
                console.error('Failed to set mode:', error);
                showToast('Failed to set mode', 'error');
            }
        }

        async function controlHotspot(action) {
            if (!isRoot) {
                showToast('Must run as root to control hotspot', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/hotspot/${action}`, { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    showToast(result.message || `Hotspot ${action} successful`, 'success');
                    loadStatus();
                } else {
                    showToast(result.detail || `Failed to ${action} hotspot`, 'error');
                }
            } catch (error) {
                console.error(`Failed to ${action} hotspot:`, error);
                showToast(`Failed to ${action} hotspot`, 'error');
            }
        }

        function showTab(tab) {
            document.getElementById('tab-characters').classList.toggle('tab-active', tab === 'characters');
            document.getElementById('tab-ssids').classList.toggle('tab-active', tab === 'ssids');
            document.getElementById('characters-panel').style.display = tab === 'characters' ? 'block' : 'none';
            document.getElementById('ssids-panel').style.display = tab === 'ssids' ? 'block' : 'none';

            if (tab === 'ssids') {
                loadSSIDs();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-error',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';

            const toast = document.createElement('div');
            toast.className = `alert ${alertClass} mb-2 shadow-lg`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStatus();
            loadCharacters();

            // Refresh status every 30 seconds
            setInterval(loadStatus, 30000);
        });
    </script>
</body>
</html>
